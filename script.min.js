if(!window.IntersectionObserver){import("https://polyfill.io/v3/polyfill.min.js?features=IntersectionObserver")}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(callback){return setTimeout(callback,16)}}class KnowledgeTreasury{constructor(){this.currentLanguage=localStorage.getItem("language")||"ar";this.translations={};this.notifications=[];this.searchSuggestions=[];this.contentFilters={category:"all",sort:"date"};this.observers=[];this.cachedElements=null;this.init()}init(){this.loadTranslations().then(()=>{this.applyLanguage(this.currentLanguage);this.cachedElements=document.querySelectorAll("[data-translate]");this.setupEventListeners();this.setupIntersectionObserver();this.setupScrollEffects();this.showWelcomeNotification()})}async loadTranslations(retryCount=0){try{const response=await fetch("translations.json");if(!response.ok)throw new Error("Network response was not ok");this.translations=await response.json()}catch(error){console.error("فشل في تحميل ملف الترجمات:",error);if(retryCount<3){console.log(`إعادة المحاولة ${retryCount+1} لتحميل الترجمات...`);setTimeout(()=>this.loadTranslations(retryCount+1),1e3)}else{this.showNotification("error",{},"error");this.translations={}}}}applyLanguage(lang){this.currentLanguage=lang;localStorage.setItem("language",lang);const html=document.documentElement;html.lang=lang;html.dir=lang==="ar"?"rtl":"ltr";html.style.fontFamily=lang==="am"?"'Noto Sans Ethiopic', sans-serif":"'Cairo', sans-serif";this.translatePage(lang);this.updateLanguageButtons(lang);this.showNotification("languageChange",{lang:lang==="ar"?"العربية":"አማርኛ"},"info")}translatePage(lang){try{this.cachedElements.forEach(element=>{const key=element.getAttribute("data-translate");const translation=this.getTranslation(key,lang);if(translation){if(element.tagName==="INPUT"&&element.type==="text"){element.placeholder=translation}else{element.textContent=translation}}})}catch(error){console.error("خطأ في ترجمة الصفحة:",error);this.showNotification("error",{},"error")}}getTranslation(key,lang){const keys=key.split(".");let value=this.translations;for(const k of keys){value=value?.[k]}return value?.[lang]||value}updateLanguageButtons(activeLang){const buttons=document.querySelectorAll(".language-switcher button");buttons.forEach(button=>{const lang=button.getAttribute("data-lang");button.classList.toggle("active",lang===activeLang)})}setupLanguageSwitcher(){const languageButtons=document.querySelectorAll(".language-switcher button");languageButtons.forEach(button=>{button.addEventListener("click",e=>{const language=e.target.getAttribute("data-lang");this.applyLanguage(language)})})}showNotification(key,params={},type="info"){const message=this.getTranslation(`notifications.${key}`,this.currentLanguage);if(!message)return;let formattedMessage=message;for(const[param,value]of Object.entries(params)){formattedMessage=formattedMessage.replace(`\${${param}}`,value)}const notification=document.createElement("div");notification.className=`notification notification-${type}`;notification.innerHTML=`
            <span>${formattedMessage}</span>
            <button class="notification-close">&times;</button>
        `;try{document.body.appendChild(notification)}catch(error){console.error("خطأ في عرض الإشعار:",error);return}this.playNotificationSound();setTimeout(()=>notification.classList.add("show"),10);setTimeout(()=>this.removeNotification(notification),5e3);const closeBtn=notification.querySelector(".notification-close")||document.getElementById("closeNotification");if(closeBtn){closeBtn.addEventListener("click",()=>{this.removeNotification(notification)})}}playNotificationSound(){const audio=document.getElementById("notificationSound");if(audio){audio.play().catch(error=>{console.error("فشل في تشغيل صوت الإشعار:",error)})}}removeNotification(notification){notification.classList.remove("show");setTimeout(()=>{if(notification.parentNode){notification.parentNode.removeChild(notification)}},300)}showWelcomeNotification(){setTimeout(()=>{this.showNotification("welcome",{},"success")},1e3)}setupSearch(){const searchInput=document.querySelector(".search-box input");const searchButton=document.querySelector(".search-box button");const suggestionsContainer=document.createElement("div");suggestionsContainer.className="search-suggestions";searchInput.parentNode.appendChild(suggestionsContainer);searchInput.addEventListener("input",e=>{const query=e.target.value.trim();if(query.length>1){this.generateSearchSuggestions(query);this.showSearchSuggestions()}else{this.hideSearchSuggestions()}});searchInput.addEventListener("keydown",e=>{if(e.key==="Enter"){this.performSearch(searchInput.value.trim())}});searchButton.addEventListener("click",()=>{this.performSearch(searchInput.value.trim())});document.addEventListener("click",e=>{if(!searchInput.contains(e.target)&&!suggestionsContainer.contains(e.target)){this.hideSearchSuggestions()}})}generateSearchSuggestions(query){const allContent=["تفسير القرآن","حديث نبوي","فقه إسلامي","عقيدة إسلامية","تزكية النفس","دعوة إسلامية","سيرة النبي","علوم الحديث","أصول الفقه","التصوف الإسلامي","الأخلاق الإسلامية"];this.searchSuggestions=allContent.filter(item=>item.toLowerCase().includes(query.toLowerCase())).slice(0,5)}showSearchSuggestions(){const suggestionsContainer=document.querySelector(".search-suggestions");suggestionsContainer.innerHTML="";this.searchSuggestions.forEach(suggestion=>{const suggestionElement=document.createElement("div");suggestionElement.className="search-suggestion";suggestionElement.textContent=suggestion;suggestionElement.addEventListener("click",()=>{document.querySelector(".search-box input").value=suggestion;this.performSearch(suggestion);this.hideSearchSuggestions()});suggestionsContainer.appendChild(suggestionElement)});suggestionsContainer.style.display="block"}hideSearchSuggestions(){const suggestionsContainer=document.querySelector(".search-suggestions");if(suggestionsContainer){suggestionsContainer.style.display="none"}}performSearch(query){if(!query){this.showNotification("searchEmpty",{},"warning");return}try{const contentCards=document.querySelectorAll("#latest .content-card");let matchCount=0;contentCards.forEach(card=>{const title=card.querySelector("h3").textContent.toLowerCase();const description=card.querySelector(".card-description").textContent.toLowerCase();const author=card.querySelector(".card-meta span:first-child").textContent.toLowerCase();const matches=title.includes(query.toLowerCase())||description.includes(query.toLowerCase())||author.includes(query.toLowerCase());card.style.display=matches?"block":"none";if(matches)matchCount++});if(matchCount>0){this.showNotification("searchResults",{count:matchCount,query:query},"success")}else{this.showNotification("noResults",{},"warning")}}catch(error){console.error("خطأ في البحث:",error);this.showNotification("error",{},"error")}}setupFilters(){const categoryFilter=document.getElementById("categoryFilter");const typeFilter=document.getElementById("typeFilter");const languageFilter=document.getElementById("languageFilter");if(categoryFilter){categoryFilter.addEventListener("change",e=>{this.applyFilter("category",e.target.value)})}if(typeFilter){typeFilter.addEventListener("change",e=>{this.applyFilter("type",e.target.value)})}if(languageFilter){languageFilter.addEventListener("change",e=>{this.applyFilter("language",e.target.value)})}}applyFilter(filterType,filterValue){this.contentFilters[filterType]=filterValue;this.showNotification("filterApplied",{filter:filterValue},"info");try{const contentCards=document.querySelectorAll("#latest .content-card");contentCards.forEach(card=>{let showCard=true;if(filterType==="category"&&filterValue!=="all"){const cardTitle=card.querySelector("h3").textContent.toLowerCase();if(filterValue==="quran"&&!cardTitle.includes("قرآن"))showCard=false;if(filterValue==="hadith"&&!cardTitle.includes("حديث")&&!cardTitle.includes("صالحين"))showCard=false;if(filterValue==="fiqh"&&!cardTitle.includes("فقه"))showCard=false}if(filterType==="type"&&filterValue!=="type"){const contentType=card.querySelector(".content-type").textContent.toLowerCase();if(filterValue==="audio"&&!contentType.includes("صوتي"))showCard=false;if(filterValue==="video"&&!contentType.includes("مرئي"))showCard=false;if(filterValue==="text"&&!contentType.includes("نصي"))showCard=false}if(filterType==="language"&&filterValue!=="language"){const cardLanguage=card.getAttribute("data-language");if(cardLanguage!==filterValue)showCard=false}card.style.display=showCard?"block":"none"})}catch(error){console.error("خطأ في تطبيق المرشح:",error);this.showNotification("error",{},"error")}}setupIntersectionObserver(){const observerOptions={threshold:.1,rootMargin:"0px 0px -50px 0px"};const observer=new IntersectionObserver(entries=>{entries.forEach(entry=>{if(entry.isIntersecting){entry.target.classList.add("animate-in");observer.unobserve(entry.target)}})},observerOptions);try{const animateElements=document.querySelectorAll(".category-card, .content-card, .author-card");animateElements.forEach(element=>{observer.observe(element)})}catch(error){console.error("خطأ في إعداد مراقب التقاطع:",error);this.showNotification("error",{},"error")}this.observers.push(observer)}setupScrollEffects(){let ticking=false;const heroBackground=document.querySelector(".hero-background img");if(heroBackground){heroBackground.style.willChange="transform"}const sectionTitles=document.querySelectorAll("section h2");sectionTitles.forEach(title=>{title.style.willChange="transform, opacity"});const scrollHandler=()=>{if(!ticking){requestAnimationFrame(()=>{const scrollTop=window.pageYOffset;if(heroBackground){const scrolled=scrollTop;const rate=scrolled*-.5;heroBackground.style.transform=`translateY(${rate}px)`}sectionTitles.forEach(title=>{const rect=title.getBoundingClientRect();const elementTop=rect.top+scrollTop;const distance=scrollTop-elementTop+window.innerHeight;if(distance>0&&distance<window.innerHeight){const progress=distance/window.innerHeight;title.style.transform=`translateY(${progress*-20}px)`;title.style.opacity=.5+progress*.5}});ticking=false});ticking=true}};window.addEventListener("scroll",scrollHandler,{passive:true})}setupEventListeners(){const searchInput=document.querySelector(".search-box input");const searchButton=document.querySelector(".search-box button");const categoryFilter=document.getElementById("categoryFilter");const typeFilter=document.getElementById("typeFilter");const languageFilter=document.getElementById("languageFilter");const googlePlayBtn=document.getElementById("googlePlayBtn");const appStoreBtn=document.getElementById("appStoreBtn");const contentCards=document.querySelectorAll(".content-card");const closeModalBtn=document.getElementById("closeModal");const closeAppModalBtn=document.getElementById("closeAppModal");const modals=document.querySelectorAll(".modal");const readMoreLinks=document.querySelectorAll('a[href="#"]');const authButtons=document.querySelectorAll(".auth-buttons button");const categoryCards=document.querySelectorAll(".category-card");const mobileMenuBtn=document.getElementById("mobileMenuBtn");this.setupLanguageSwitcher();this.setupSearch();this.setupFilters();if(googlePlayBtn){googlePlayBtn.addEventListener("click",()=>{this.openAppModal()})}if(appStoreBtn){appStoreBtn.addEventListener("click",()=>{this.openAppModal()})}contentCards.forEach(card=>{card.addEventListener("click",()=>{this.openContentModal(card)})});if(closeModalBtn){closeModalBtn.addEventListener("click",()=>{this.closeModal()})}if(closeAppModalBtn){closeAppModalBtn.addEventListener("click",()=>{this.closeModal()})}modals.forEach(modal=>{modal.addEventListener("click",e=>{if(e.target===modal){this.closeModal()}})});document.addEventListener("keydown",e=>{if(e.key==="Escape"){this.closeModal()}});readMoreLinks.forEach(link=>{link.addEventListener("click",e=>{e.preventDefault();const action=e.target.textContent;this.showNotification("featureDeveloping",{action:action},"warning")})});authButtons.forEach(button=>{button.addEventListener("click",e=>{e.preventDefault();const action=e.target.textContent;this.showNotification("featureDeveloping",{action:action},"warning")})});categoryCards.forEach(card=>{card.addEventListener("click",()=>{const categoryName=card.querySelector("h3").textContent;this.showNotification("openDetail",{},"info")})});if(mobileMenuBtn){mobileMenuBtn.addEventListener("click",()=>{const nav=document.getElementById("mainNav");if(nav){nav.classList.toggle("active")}})}window.addEventListener("beforeunload",()=>{this.cleanup()})}openContentModal(card){const title=card.querySelector("h3").textContent;const author=card.querySelector(".card-meta span:first-child").textContent;const duration=card.querySelector(".card-meta span:last-child").textContent;const description=card.querySelector(".card-description").textContent;const image=card.querySelector(".card-image").style.backgroundImage;document.getElementById("modalTitle").textContent=title;document.getElementById("modalAuthor").textContent=author;document.getElementById("modalDuration").textContent=duration;document.getElementById("modalDescription").textContent=description;document.getElementById("modalImage").style.backgroundImage=image;const modal=document.getElementById("contentModal");modal.style.display="block";modal.setAttribute("aria-hidden","false");document.body.style.overflow="hidden";modal.focus()}closeModal(){const modals=document.querySelectorAll(".modal");modals.forEach(modal=>{modal.style.display="none";modal.setAttribute("aria-hidden","true")});document.body.style.overflow="auto"}openAppModal(){const modal=document.getElementById("appModal");modal.style.display="block";modal.setAttribute("aria-hidden","false");document.body.style.overflow="hidden";modal.focus()}cleanup(){this.observers.forEach(observer=>{observer.disconnect()});this.observers=[];this.notifications=[];this.searchSuggestions=[]}}document.addEventListener("DOMContentLoaded",()=>{new KnowledgeTreasury;const progressBar=document.getElementById("progressBar");if(progressBar){window.addEventListener("scroll",()=>{const scrollTop=window.pageYOffset;const docHeight=document.documentElement.scrollHeight-window.innerHeight;const scrollPercent=scrollTop/docHeight*100;progressBar.style.width=scrollPercent+"%"})}});